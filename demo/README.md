# VC AuthN Demo Applications

This is a demo application that uses vc-authn-oidc as Identity Provider to access a web resource directly, without requiring the use of third-party Access and Identity Management solutions.

## Running the Demo

### Pre-Requisites

The application in this demo require you to have a mobile wallet installed on your mobile phone, and to have obtained a `Verified Email` credential from this [Email Verification Service](https://email-verification.vonx.io).

You will also need to have Docker and ngrok installed and running.

`vc-authn-oidc` depends on [von-network](https://github.com/bcgov/von-network): follow the instructions in the von-network readme to start one locally on your machine. Alternatively, a public ledger can be used by setting the `LEDGER_URL` environment variable. As an example, to use the BCovrin Test ledger: `LEDGER_URL=https://test.bcovrin.vonx.io`.

### Running the Apps

In addition to the above pre-requirements, you will need three bash shell instances open at the following locations:

1. [vc-authn-oidc/docker](../docker)
2. [demo/docker](./docker)
3. [demo/scripts](./scripts)

Run `./manage build` in shells number `1` and `2` to assemble the images required to run the demo services.

When the builds are completed, run [start-ngrok.sh](./scripts/start-ngrok.sh) in shell number `3`. This will run an instance of `ngrok` used to allow your mobile agent to communicate with the services running on localhost.

Once ngrok is running go to http://localhost:4040/status : you will notice the two tunnels `vc-authn-agent` and `vc-authn-controller` have been created and have been assigned an ngrok public endpoint. Take note of the urls that have been assigned, as you will need them to start the services.

Now we can start the services:

- In shell number `1` run this command, replacing {NGROK_AGENT_URL} and ${NGROK_CONTROLLER_URL} with the values from the ngrok status page:
```NGROK_AGENT_URL=${NGROK_AGENT_URL} NGROK_CONTROLLER_URL=${NGROK_CONTROLLER_URL} ./manage start```

Once the services are running, we will need to configure vc-authn-oidc so that it will request the `Verified Email` credential. To do this, execute the following command in another shell (you can use, as an example, shell number `2`):

```bash
curl -X POST "http://localhost:5000/api/vc-configs" -H "accept: application/json" -H "X-Api-Key: controller-api-key" -H "Content-Type: application/json-patch+json" -d "{\"id\": \"verified-email\",\"subject_identifier\": \"email\", \"configuration\": { \"name\": \"verified-email\", \"version\": \"1.0\", \"requested_attributes\": [ { \"name\": \"email\", \"restrictions\": [ { \"schema_name\": \"verified-email\", \"issuer_did\": \"MTYqmTBoLT7KLP5RNfgK3b\" } ] } ], \"requested_predicates\": [] }}"
```

Additionally, we need to add the valid redirect URI for the test client to the vc-authn-oidc-controller database: a new entry should be created in the `ClientRedirectUris` table. To acquire the credentials to connect to to the database you can refer to the environment variables set in the `controller-db` section of the main [manage](../docker/manage) script, however the default parameters for the demo clients have been pre-configured for convenience.

- In shell number `2` run this command, replacing ${NGROK_CONTROLLER_URL} with the value fro the ngrok status page:  ```NGROK_CONTROLLER_URL=${NGROK_CONTROLLER_URL} ./manage start```

### Try the Demo!

Once the applications have started, navigate your web browser to http://localhost:8080 and try clicking the link to provide a `Verified Email` credential: you will be redirected to a page displaying a QR code generated by `vc-authn-oidc`. If you have previously obtained the `Verified Email` credential, you should be able to scan the code with your mobile wallet app, present the required proof and be able to access the protected page in the web application.
